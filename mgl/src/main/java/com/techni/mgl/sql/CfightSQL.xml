<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mgl.Cfight">

	<resultMap type="com.techni.mgl.domain.CfightVO" id="CfightVOMap">
		<result column="MGL_Cfight_IDX" property="cf_idx"/>
		<result column="MGL_CLUB_IDX" property="c_idx"/>
		<result column="MGL_CLUB_NM" property="c_nm"/>
		<result column="MGL_CFIGHT_NM" property="cf_nm"/>
		<result column="MGL_CFIGHT_YN" property="cf_yn"/>
		<result column="MGL_CFIGHT_START" property="cf_start"/>
		<result column="MGL_CFIGHT_END" property="cf_end"/>
		<result column="MGL_CFIGHT_STIME" property="cf_sTime"/>
		<result column="MGL_CFIGHT_ETIME" property="cf_eTime"/>
		<result column="MGL_CFIGHT_POINT" property="cf_point"/>
		<result column="MGL_CFIGHT_MATCH_LIST" property="cf_match_list"/>
		<result column="MGL_CFIGHT_TIME" property="cf_time"/>
		<result column="MGL_CFIGHT_LOCATION" property="cf_location"/>
		<result column="MGL_CFIGHT_CNM" property="cf_cnm"/>
		<result column="MGL_CFIGHT_COURT" property="cf_court"/>
		<result column="MGL_CFIGHT_METH" property="cf_meth"/>
		<result column="MGL_CFIGHT_BODY" property="cf_body"/>
		<result column="MGL_CFIGHT_C_IDX" property="cf_c_idx"/>
		<result column="MGL_CFIGHT_TYPE_IDX" property="cf_t_idx"/>
		<result column="MGL_CFIGHT_TYPE_NM" property="cf_t_nm"/>
		<result column="MGL_CFIGHT_TYPE_COURT" property="cf_t_court"/>
		<result column="MGL_CFIGHT_TYPE_COUNT" property="cf_t_count"/>
		<result column="MGL_CFIGHT_TYPE_NUM" property="cf_t_num"/>
		<result column="MGL_USER_MID" property="c_u_mid"/>
		<result column="MGL_USER_ID" property="u_id"/>
		<result column="MGL_USER_NM" property="u_nm"/>
		<result column="MGL_USER_SEX" property="u_sex"/>
		<result column="MGL_USER_PHOTO" property="u_photo"/>
		<result column="MGL_UCLUB_GRADE_CD" property="u_club_gd"/>
		<result column="MGL_CFIGHT_TYPE_KIND" property="cf_t_kind"/>
		<result column="MGL_CFIGHT_USER_NM" property="cf_u_nm"/>
		<result column="MGL_CFIGHT_USER_ID" property="cf_u_id"/>
		<result column="MGL_CFIGHT_USER_PHOTO" property="cf_u_photo"/>
		<result column="MGL_CFIGHT_USER_AGE" property="cf_u_age"/>
		<result column="MGL_CFIGHT_USER_SEX" property="cf_u_sex"/>
		<result column="MGL_CFIGHT_USER_GD" property="cf_u_gd"/>
		<result column="MGL_CFIGHT_USER_WEIGHT" property="cf_u_weight"/>
		<result column="MGL_CFIGHT_TEAM_IDX" property="cf_team_idx"/>
		<result column="MGL_CFIGHT_USER_A" property="cf_team_a_id"/>
		<result column="MGL_CFIGHT_USER_B" property="cf_team_b_id"/>
		<result column="MGL_CFIGHT_GROUP_IDX" property="cf_g_idx"/>
		<result column="MGL_CFIGHT_GROUP_COUNT" property="cf_g_count"/>
		<result column="MGL_CFIGHT_W_DAT" property="cf_w_date"/>
		<result column="MGL_CFIGHT_STATUS" property="cf_status"/>
		<result column="MGL_CFIGHT_ORDER" property="cf_order"/>
		<result column="MGL_CFIGHT_NO" property="cf_no"/>
		<result column="MGL_CFIGHT_AT_ID1" property="cf_at_id1"/>
		<result column="MGL_CFIGHT_AT_ID2" property="cf_at_id2"/>
		<result column="MGL_CFIGHT_BT_ID1" property="cf_bt_id1"/>
		<result column="MGL_CFIGHT_BT_ID2" property="cf_bt_id2"/>
		<result column="MGL_CFIGHT_GIDX" property="cf_gidx"/>
	</resultMap>
	<!-- 대항전 리스트 -->
	<select id="cFightList" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_IDX,MGL_CFIGHT_NM,MGL_CFIGHT_START,MGL_CFIGHT_END 
		FROM 
			MGL_CFIGHT A
		JOIN 
			(SELECT * FROM MGL_CFIGHT_YN WHERE MGL_CLUB_IDX = #{c_idx})  B
		USING
			(MGL_CFIGHT_IDX) 
		WHERE
			B.MGL_CFIGHT_YN IS NULL 
		OR 
			B.MGL_CFIGHT_YN = "Y"
		AND
			A.MGL_CFIGHT_YN = "N"
		GROUP BY 
			MGL_CFIGHT_IDX
	</select>
	<!-- 클럽 이름으로 인덱스 가져오기 -->
	<select id="selectCidx" resultMap="CfightVOMap">
		SELECT 
			MGL_CLUB_IDX,MGL_CLUB_NM 
		FROM 
			MGL_CLUB 
		WHERE 
			MGL_CLUB_NM = #{c_nm} 
		AND 
			MGL_CLUB_YN = "Y"
	</select>
	<!-- 대항전 삭제 -->
	<update id="cFightDelete">
		UPDATE MGL_CFIGHT
		SET MGL_CFIGHT_YN = "Y"
		WHERE MGL_CFIGHT_IDX = #{cf_idx}
	</update>
	<!-- 대항전 인서트 -->
	<insert id="cFightInsert">
		<selectKey keyProperty="cf_idx" resultType="String" order="BEFORE">
			SELECT 
				concat("CF",cast(date_format(now(),"%y")as char(2)),LPAD((SELECT * FROM(SELECT MAX(MGL_CFIGHT_SEQ) FROM MGL_SEQ) NEXT),5,0))	
		</selectKey>
		INSERT INTO 
			MGL_CFIGHT VALUES(
				#{cf_idx},
				#{cf_location},
				#{cf_start},
				#{cf_end},
				#{cf_sTime},
				#{cf_eTime},
				#{cf_point},
				#{cf_time},
				#{cf_cnm},
				#{cf_court},
				#{cf_meth},
				#{cf_body},
				#{c_idx},
				#{cf_nm},
				"N",
				"N"
			)
	</insert>
	<!-- 시퀀스값 증가 -->
	<update id="cFightSeq">
		update mgl_seq set mgl_cfight_seq = mgl_cfight_seq+1
	</update>
	<update id="cFightYnSeq">
		update mgl_seq set mgl_cfight_yn_seq = mgl_cfight_yn_seq+1
	</update>
	<update id="cFightTypeSeq">
		update mgl_seq set mgl_cfight_type_seq = mgl_cfight_type_seq+1
	</update>
	<update id="cFightTeamSeq">
		update mgl_seq set mgl_cfight_team_seq = mgl_cfight_team_seq+1
	</update>
	<!-- yn테이블 인서트 -->
	<insert id="cFightYnInsert">
		INSERT INTO 
			MGL_CFIGHT_YN 
			VALUES(
				concat("CY",cast(date_format(now(),"%y")as char(2)),LPAD((SELECT * FROM(SELECT MAX(MGL_CFIGHT_YN_SEQ) FROM MGL_SEQ) NEXT),5,0)),
				#{cf_idx},
				#{c_idx},
				#{yn},
				NULL
			)
	</insert>
	<!-- 종목테이블 인서트 -->
	<insert id="cFightTypeInsert">
		INSERT INTO MGL_CFIGHT_TYPE 
			VALUES(
				concat("CT",cast(date_format(now(),"%Y%m%d")as char(8)),LPAD((SELECT * FROM(SELECT MAX(MGL_CFIGHT_TYPE_SEQ) FROM MGL_SEQ) NEXT),4,0)),
				#{cf_idx},
				#{cf_t_nm},
				#{cf_t_num},
				#{cf_t_kind},
				NULL
			)
	</insert>
	<!-- 대항전 내용과 참여 클럽 리스트 -->
	<select id="cFightJoinClub" resultMap="CfightVOMap">
		SELECT 
			c.mgl_user_mid,B.MGL_CFIGHT_YN,a.*,b.mgl_club_idx,c.mgl_club_nm,count(case when mgl_uclub_mng !="가입대기" and mgl_uclub_mng !="탈퇴" then 1 end)as c_count 
		FROM 
			MGL_CFIGHT A 
		JOIN 
			MGL_CFIGHT_YN B 
		USING
			(MGL_CFIGHT_IDX) 
		JOIN 
			MGL_CLUB C 
		USING
			(MGL_CLUB_IDX) 
		JOIN 
			MGL_UCLUB D 
		USING
			(MGL_CLUB_IDX) 
		WHERE 
			MGL_CFIGHT_IDX = #{cf_idx} 
		AND 
			B.MGL_CLUB_IDX != A.MGL_CFIGHT_C_IDX  
		GROUP BY B.MGL_CLUB_IDX
	</select>
	<!-- 종목과 주최클럽 리스트 -->
	<select id="cFightTypeList" resultMap="CfightVOMap">
	SELECT 
		* 
	FROM
		(
		SELECT 
			MGL_CFIGHT_YN,mgl_cfight_c_idx,c.mgl_user_mid,A.*,MGL_CLUB_NM 
		FROM 
			MGL_CFIGHT_TYPE A 
		JOIN 
			MGL_CFIGHT B 
		USING
			(MGL_CFIGHT_IDX) 
		JOIN 
			MGL_CLUB C 
		ON 
			C.MGL_CLUB_IDX = B.MGL_CFIGHT_C_IDX 
		JOIN 
			MGL_UCLUB 
		USING
			(MGL_CLUB_IDX) 
		WHERE 
			MGL_CFIGHT_IDX = #{cf_idx} 
		GROUP BY 
			MGL_CFIGHT_TYPE_IDX 
		ORDER BY 
			MGL_CFIGHT_TYPE_NUM
		) JA LEFT JOIN
		(
			select 
				MGL_CFIGHT_IDX,mgl_cfight_nm,count(*)as c_t_count 
			from 
				(
					select 
						* 
					from
						( 
							SELECT 
								DISTINCT(mgl_cfight_user_a) as user_a
							FROM 
								MGL_CFIGHT_TEAM 
							join 
								mgl_cfight 
							using 
								(mgl_cfight_idx) 
							WHERE 
								MGL_CFIGHT_IDX = #{cf_idx}
							AND
								MGL_CLUB_IDX = #{c_idx}
						) aa 
					left join
						(
							SELECT 
								DISTINCT(mgl_cfight_user_b) as user_b
							FROM 
								MGL_CFIGHT_TEAM 
							join 
								mgl_cfight 
							using 
								(mgl_cfight_idx) 
							WHERE 
								MGL_CFIGHT_IDX = #{cf_idx}
							AND
								MGL_CLUB_IDX = #{c_idx}
						) bb
					on 
						aa.user_a = bb.user_b
				union	
					select 
						* 
					from
						( 
							SELECT 
								DISTINCT(mgl_cfight_user_a) as user_c
							FROM 
								MGL_CFIGHT_TEAM 
							join 
								mgl_cfight 
							using 
								(mgl_cfight_idx) 
							WHERE 
								MGL_CFIGHT_IDX = #{cf_idx}
							AND
								MGL_CLUB_IDX = #{c_idx}
						) aa 
					right join
						(
							SELECT 
								DISTINCT(mgl_cfight_user_b) as user_d
							FROM 
								MGL_CFIGHT_TEAM 
							join 
								mgl_cfight 
							using 
								(mgl_cfight_idx) 
							WHERE 
								MGL_CFIGHT_IDX = #{cf_idx}
							AND
								MGL_CLUB_IDX = #{c_idx}
						) bb
					on 
						aa.user_c = bb.user_d
			) as ct_count , 
			(
				SELECT 
					MGL_CFIGHT_IDX,mgl_cfight_nm 
				FROM 
					MGL_CFIGHT 
				WHERE 
					MGL_CFIGHT_IDX = #{cf_idx}
			) AS SB 
		) JB
		ON 
			JA.MGL_CFIGHT_IDX = JB.MGL_CFIGHT_IDX
		LEFT JOIN
			(	
				SELECT 
					c_count,A.MGL_CLUB_IDX,IFNULL(MGL_CFIGHT_IDX,#{cf_idx}) AS MGL_CFIGHT_IDX 
				FROM
					(
						SELECT 
							COUNT(*)AS c_count,MGL_CLUB_IDX  
						FROM 
							MGL_UCLUB WHERE MGL_CLUB_IDX = #{c_idx}
						AND 
							MGL_UCLUB_MNG !='가입대기'
					)A 
				LEFT JOIN 
					(SELECT * from MGL_CFIGHT_USER WHERE MGL_CFIGHT_IDX=#{cf_idx}) B
				ON 
					A.MGL_CLUB_IDX COLLATE utf8mb4_general_ci=B.MGL_CLUB_IDX 
				GROUP by mgl_club_idx
			) JC
		ON 
			JB.MGL_CFIGHT_IDX = JC.MGL_CFIGHT_IDX
	</select>
	<!-- 대항전 참석 여부 -->
	<update id="ynChk">
		UPDATE 
			MGL_CFIGHT_YN
		SET
			MGL_CFIGHT_YN = #{yn}
		WHERE 
			MGL_CFIGHT_IDX = #{cf_idx}
		AND
			MGL_CLUB_IDX = #{c_idx}
	</update>
	<!-- 참석하지않은 유저리스트 -->
	<select id="cFightUserList" resultMap="CfightVOMap">
		SELECT * FROM
			(
				SELECT 
					* 
				FROM 
				(
					SELECT 
						MGL_CFIGHT_NM FROM MGL_CFIGHT 
					WHERE 
						MGL_CFIGHT_IDX = #{cf_idx}
				) A ,
				(
					SELECT 
						MGL_CLUB_IDX,count(case when mgl_uclub_mng !="가입대기" and mgl_uclub_mng !="탈퇴" then 1 end)as c_count FROM MGL_UCLUB WHERE MGL_CLUB_IDX =#{c_idx}
				) B
				) JA LEFT JOIN
				(	
					SELECT 
						MGL_USER_SEX,B.MGL_USER_ID,A.MGL_CLUB_IDX,concat(left(left(now(),4)-left(MGL_USER_BIRTH,4)+1,1),"0대") AS u_age,
					 	A.MGL_UCLUB_GRADE_CD,B.MGL_USER_NM,B.MGL_USER_PHOTO
					FROM 
						MGL_UCLUB A 
					JOIN 
						MGL_USER B 
					USING
						(MGL_USER_ID) 
					LEFT JOIN 
						(
							SELECT 
								* 
							FROM 
								MGL_CFIGHT_USER 
							WHERE 
								MGL_CFIGHT_IDX = #{cf_idx}
							) C
					ON 
						A.MGL_CLUB_IDX COLLATE utf8mb4_general_ci = C.MGL_CLUB_IDX 
					AND 
						A.MGL_USER_ID = C.MGL_CFIGHT_USER_ID
					WHERE 
						A.MGL_CLUB_IDX = #{c_idx}
					AND 
						MGL_UCLUB_MNG != "가입대기" 
					AND 
						MGL_UCLUB_MNG != "탈퇴"
					AND 
						MGL_CFIGHT_USER_ID IS NULL
					) JB
					ON JA.MGL_CLUB_IDX = JB.MGL_CLUB_IDX	
					
	</select>
	<!-- 참석한 유저 리스트 -->
	<select id="cFightJoinUserList" resultMap="CfightVOMap">
		SELECT 
			A.MGL_USER_ID,B.MGL_CLUB_IDX,concat(left(left(now(),4)-left(MGL_USER_BIRTH,4)+1,1),"0대") AS u_age,
		 	B.MGL_UCLUB_GRADE_CD,A.MGL_USER_NM,A.MGL_USER_PHOTO
		FROM 
			MGL_USER A 
		JOIN 
			MGL_UCLUB B 
		USING
			(MGL_USER_ID) 
		RIGHT JOIN 
			(
				SELECT 
					* 
				FROM 
					MGL_CFIGHT_USER 
				WHERE 
					MGL_CFIGHT_IDX = #{cf_idx}
				) C
		ON 
			B.MGL_CLUB_IDX COLLATE utf8mb4_general_ci = C.MGL_CLUB_IDX 
		AND 
			B.MGL_USER_ID = C.MGL_CFIGHT_USER_ID
		WHERE 
			B.MGL_CLUB_IDX = #{c_idx}
		AND 
			MGL_UCLUB_MNG != "가입대기" 
		AND 
			MGL_UCLUB_MNG != "탈퇴"
	</select>
	<!-- 대항전 유저테이블로 인서트 -->
	<insert id="cFightUserInsert">
		INSERT INTO
			MGL_CFIGHT_USER values
			<foreach collection="list" item="item" separator=",">
				(
				concat(#{cf_idx},#{item.u_id},#{c_idx}),
				#{c_idx},
				#{cf_idx},
				#{item.u_id},
				(SELECT MGL_USER_NM FROM MGL_USER WHERE MGL_USER_ID = #{item.u_id}),
				(SELECT MGL_USER_PHOTO FROM MGL_USER WHERE MGL_USER_ID = #{item.u_id}),
				(SELECT concat(left(left(now(),4)-left(MGL_USER_BIRTH,4)+1,1),"0대") FROM MGL_USER WHERE MGL_USER_ID = #{item.u_id}),
				(SELECT MGL_USER_SEX FROM MGL_USER WHERE MGL_USER_ID = #{item.u_id}),
				(SELECT MGL_UCLUB_GRADE_CD FROM MGL_UCLUB WHERE MGL_USER_ID = #{item.u_id} AND MGL_CLUB_IDX = #{c_idx}),
				0
				)
			</foreach>
	</insert>
	
	<delete id="cFightUserDelete">
		DELETE FROM
			MGL_CFIGHT_USER 
		WHERE MGL_CFIGHT_USER_IDX IN (
			<foreach collection="list" item="item" separator=",">
			#{item.cf_idx}
			</foreach>
			)
	</delete>

	<select id="teamUser" resultMap="CfightVOMap">
		SELECT 
			JC.* 
		FROM
			(
				SELECT 
					* 
				FROM 
					MGL_CFIGHT_USER 
					<if test='cf_t_kind =="남복"'>
						WHERE
							MGL_CFIGHT_USER_SEX = "M"
					</if>
					<if test='cf_t_kind =="여복"'>
						WHERE
							MGL_CFIGHT_USER_SEX = "F"
					</if>
			) JC 
			LEFT JOIN
				(
					SELECT 
						JB.* 
					FROM 
						(
							SELECT 
								A.MGL_CFIGHT_IDX,MGL_CFIGHT_USER_A , MGL_CFIGHT_USER_B 
							FROM 
								MGL_CFIGHT_TEAM A 
							JOIN 
								MGL_CFIGHT_TYPE B 
							USING
								(MGL_CFIGHT_TYPE_IDX)
							WHERE 
								MGL_CFIGHT_TYPE_KIND =#{cf_t_kind} 
							 AND 
							 	A.MGL_CFIGHT_IDX=#{cf_idx}
				) JA , 
			(
				SELECT 
					* 
				FROM 
					MGL_CFIGHT_USER
			) JB
			WHERE 
				JB.MGL_CFIGHT_USER_ID = JA.MGL_CFIGHT_USER_A 
			OR 
				JB.MGL_CFIGHT_USER_ID = JA.MGL_CFIGHT_USER_B
			) JD
			ON 
				JC.MGL_CFIGHT_USER_ID = JD.MGL_CFIGHT_USER_ID
			WHERE 
				JD.MGL_CFIGHT_USER_ID IS NULL
			AND 
				JC.MGL_CFIGHT_IDX=#{cf_idx}
			AND 
				JC.MGL_CLUB_IDX =#{c_idx}
	</select>
	
	<!-- 해당 종목 팀 리스트 -->
	<select id="typeTeam" resultMap="CfightVOMap">
		SELECT 
			ja.mgl_cfight_team_idx,JA.MGL_CFIGHT_IDX,JA.MGL_CFIGHT_USER_A,JA.MGL_CFIGHT_USER_NM AS cf_t_a_nm,JA.MGL_CFIGHT_USER_AGE AS cf_t_a_age,JA.MGL_CFIGHT_USER_GD AS cf_t_a_gd ,JA.MGL_CFIGHT_USER_PHOTO AS cf_t_a_photo,
			JB.MGL_CFIGHT_USER_B,JB.MGL_CFIGHT_USER_NM AS cf_t_b_nm,JB.MGL_CFIGHT_USER_AGE AS cf_t_b_age,JB.MGL_CFIGHT_USER_GD AS cf_t_b_gd,JB.MGL_CFIGHT_USER_PHOTO as cf_t_b_photo 
		FROM 
			(
				SELECT 
					MGL_CFIGHT_USER_PHOTO,MGL_CFIGHT_TEAM_IDX,C.MGL_CFIGHT_IDX,mgl_cfight_user_B,mgl_cfight_user_a,MGL_CFIGHT_USER_NM,MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_AGE,MGL_CFIGHT_USER_GD 
				FROM 
					MGL_CFIGHT_TYPE a 
				JOIN 
					MGL_CFIGHT_TEAM b 
				USING
					(MGL_CFIGHT_TYPE_IDX)
				left join 
					mgl_cfight_user c 
				on 
					b.mgl_cfight_idx = c.mgl_cfight_idx
				and 
					b.mgl_club_idx = c.mgl_club_idx
				WHERE 
					MGL_CFIGHT_TYPE_IDX = #{cf_t_idx}
				AND 
					b.MGL_CLUB_IDX = #{c_idx}
				AND 
					mgl_cfight_user_a = c.mgl_cfight_user_id
			) JA ,
			(
				SELECT 
					MGL_CFIGHT_USER_PHOTO,MGL_CFIGHT_TEAM_IDX,C.MGL_CFIGHT_IDX,mgl_cfight_user_B,mgl_cfight_user_A,MGL_CFIGHT_USER_NM,MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_AGE,MGL_CFIGHT_USER_GD 
				FROM 
					MGL_CFIGHT_TYPE a 
				JOIN 
					MGL_CFIGHT_TEAM b 
				USING
					(MGL_CFIGHT_TYPE_IDX)
				left join 
					mgl_cfight_user c 
				on 
					b.mgl_cfight_idx = c.mgl_cfight_idx
				and 
					b.mgl_club_idx = c.mgl_club_idx
				WHERE 
					MGL_CFIGHT_TYPE_IDX = #{cf_t_idx}
				AND 
					b.MGL_CLUB_IDX = #{c_idx}
				AND 
					mgl_cfight_user_B = c.mgl_cfight_user_id
			) JB
			WHERE 
				JA.MGL_CFIGHT_USER_A = JB.MGL_CFIGHT_USER_A
			AND 
				JA.MGL_CFIGHT_USER_B = JB.MGL_CFIGHT_USER_B
			AND 
				JA.MGL_CFIGHT_TEAM_IDX = JB.MGL_CFIGHT_TEAM_IDX
	</select>
	<!-- 팀 인서트 -->
	<insert id="teamInsert">
		INSERT 
			INTO 
			MGL_CFIGHT_TEAM 
				VALUES(
					concat("CFT",cast(date_format(now(),"%Y%m%d")as char(8)),LPAD((SELECT * FROM(SELECT MAX(MGL_CFIGHT_TEAM_SEQ) FROM MGL_SEQ) NEXT),4,0))	,
					#{cf_idx},
					#{cf_t_idx},
					#{c_idx},
					#{u_id_a},
					#{u_id_b},
					NULL
				)
	</insert>
	<delete id="teamDelete">
		DELETE FROM
			MGL_CFIGHT_TEAM 
		WHERE 
			MGL_CFIGHT_TEAM_IDX = #{cf_team_idx}
	</delete>
	<!-- 각 클럽의 등록된 팀리스트 -->
	<select id="teamList" resultMap="CfightVOMap">
		select 
			* 
		from (
				SELECT 
					MGL_CFIGHT_TYPE_NUM,MGL_CFIGHT_TYPE_NM,ja.mgl_cfight_team_idx,JA.MGL_CFIGHT_IDX,JA.MGL_CFIGHT_USER_A,JA.MGL_CFIGHT_USER_NM 
					AS cf_t_a_nm,JA.MGL_CFIGHT_USER_AGE AS cf_t_a_age,JA.MGL_CFIGHT_USER_GD AS cf_t_a_gd ,JA.MGL_CFIGHT_USER_PHOTO 
					AS cf_t_a_photo, JB.MGL_CFIGHT_USER_B,JB.MGL_CFIGHT_USER_NM AS cf_t_b_nm,JB.MGL_CFIGHT_USER_AGE 
					AS cf_t_b_age,JB.MGL_CFIGHT_USER_GD AS cf_t_b_gd,JB.MGL_CFIGHT_USER_PHOTO as cf_t_b_photo 
				FROM 
					( 
						SELECT 
							MGL_CFIGHT_TYPE_NUM,MGL_CFIGHT_TYPE_NM,MGL_CFIGHT_USER_PHOTO,MGL_CFIGHT_TEAM_IDX,C.MGL_CFIGHT_IDX,mgl_cfight_user_B,mgl_cfight_user_a,MGL_CFIGHT_USER_NM,MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_AGE,MGL_CFIGHT_USER_GD 
						FROM 
							MGL_CFIGHT_TYPE a 
						JOIN 
							MGL_CFIGHT_TEAM b 
						USING 
							(MGL_CFIGHT_TYPE_IDX)
						left join 
							mgl_cfight_user c 
						on 
							b.mgl_cfight_idx = c.mgl_cfight_idx 
						and 
							b.mgl_club_idx = c.mgl_club_idx 
						WHERE 
							b.MGL_CLUB_IDX = #{c_idx}
						AND 
							mgl_cfight_user_a = c.mgl_cfight_user_id 
					) JA , 
					( 
						SELECT 
							MGL_CFIGHT_USER_PHOTO,MGL_CFIGHT_TEAM_IDX,C.MGL_CFIGHT_IDX,mgl_cfight_user_B,mgl_cfight_user_A,MGL_CFIGHT_USER_NM,MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_AGE,MGL_CFIGHT_USER_GD 
						FROM 
							MGL_CFIGHT_TYPE a 
						JOIN 
							MGL_CFIGHT_TEAM b 
						USING 
							(MGL_CFIGHT_TYPE_IDX) 
						left join 
							mgl_cfight_user c 
						on 
							b.mgl_cfight_idx = c.mgl_cfight_idx 
						and 
							b.mgl_club_idx = c.mgl_club_idx 
						WHERE 
							b.MGL_CLUB_IDX = #{c_idx}
						AND 
							mgl_cfight_user_B = c.mgl_cfight_user_id 
					) JB 
					WHERE 
						JA.MGL_CFIGHT_USER_A = JB.MGL_CFIGHT_USER_A 
					AND 
						JA.MGL_CFIGHT_USER_B = JB.MGL_CFIGHT_USER_B 
					AND 
						JA.MGL_CFIGHT_TEAM_IDX = JB.MGL_CFIGHT_TEAM_IDX 
			) ja left join
			(
				SELECT 
					COUNT(*)as c_t_count,MGL_CFIGHT_IDX,mgl_cfight_nm 
				FROM 
					MGL_CFIGHT_TEAM 
				join 
					mgl_cfight 
				using
					(mgl_cfight_idx) 
				WHERE 
					MGL_CFIGHT_IDX = #{cf_idx}
			) jb
			on 
				ja.mgl_cfight_idx = jb.mgl_cfight_idx
			LEFT JOIN
				(
					SELECT 
						COUNT(*)as c_count,MGL_CFIGHT_IDX 
					FROM 
						MGL_CFIGHT_USER 
					WHERE 
						MGL_CLUB_IDX =#{c_idx}
					AND 
						MGL_CFIGHT_IDX=#{cf_idx}
				) JC
			ON 
				JB.MGL_CFIGHT_IDX = JC.MGL_CFIGHT_IDX
			WHERE JA.MGL_CFIGHT_IDX =#{cf_idx}
			ORDER BY 
				MGL_CFIGHT_TYPE_NUM
	</select>
	<!-- 출전취소하려는 유저가 팀테이블에 있는지 확인 -->
	<select id="teamUserChk" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM 
		FROM 
			(
				SELECT 
					MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM 
				FROM 
					MGL_CFIGHT_USER 
				WHERE 
					MGL_CFIGHT_USER_ID IN (
					<foreach collection="list" item="item" separator=",">
					#{item.u_id}
					</foreach>
					)
			) A 
		LEFT 
			JOIN MGL_CFIGHT_TEAM B
		ON 
			A.MGL_CFIGHT_USER_ID = B.MGL_CFIGHT_USER_A
		OR 
			A.MGL_CFIGHT_USER_ID = B.MGL_CFIGHT_USER_B
		WHERE 
			B.MGL_CFIGHT_IDX = #{cf_idx}
		AND 
			B.MGL_CLUB_IDX = #{c_idx}
		GROUP BY 
			MGL_CFIGHT_USER_ID
	</select>
	<!-- 그룹 설정 화면 -->
	<select id="typeList" resultMap="CfightVOMap">
		SELECT 
			JA.*,JB.t_count 
		FROM 
			(
				SELECT 
					mgl_cfight_nm,mgl_cfight_c_idx,c.mgl_user_mid,A.*,MGL_CLUB_NM 
				FROM 
					MGL_CFIGHT_TYPE A 
				JOIN 
					MGL_CFIGHT B 
				USING 
					(MGL_CFIGHT_IDX) 
				JOIN 
					MGL_CLUB C 
				ON 
					C.MGL_CLUB_IDX = B.MGL_CFIGHT_C_IDX 
				JOIN 
					MGL_UCLUB 
				USING 
					(MGL_CLUB_IDX) 
				WHERE 
					MGL_CFIGHT_IDX = #{cf_idx} 
				GROUP BY 
					MGL_CFIGHT_TYPE_IDX 
				ORDER BY 
					MGL_CFIGHT_TYPE_NUM 
			) JA 
		LEFT JOIN
			(
				SELECT 
					MGL_CFIGHT_IDX,MGL_CFIGHT_TYPE_IDX,COUNT(*) AS t_count 
				FROM 
					MGL_CFIGHT_TEAM 
				WHERE 
					MGL_CFIGHT_IDX = #{cf_idx} 
				GROUP BY 
					MGL_CFIGHT_TYPE_IDX
			) JB 
		ON 
			JA.MGL_CFIGHT_TYPE_IDX = JB.MGL_CFIGHT_TYPE_IDX
		AND 
			JA.MGL_CFIGHT_IDX = JB.MGL_CFIGHT_IDX
	</select>
	<!-- 대항전에 참가한 클럽 리스트 -->
	<select id="clubList" resultMap="CfightVOMap">
	select mgl_club_idx from mgl_cfight_yn where mgl_cfight_idx = #{cf_idx} and mgl_cfight_yn = "Y"
	</select>
	<!-- 팀리스트 클럽별로 번갈아가며 출력 -->
	<select id="clubTeamList" resultMap="CfightVOMap">
			select * from 
				( select *, @rn := if(@mgl_club_idx = `mgl_club_idx`,@rn +1,if(@mgl_club_idx := `mgl_club_idx`,1,1)) as rn
					from (select a.*,b.mgl_Cfight_type_num from mgl_cfight_team a left join mgl_Cfight_type b on a.mgl_Cfight_type_idx = b.mgl_Cfight_type_idx where a.mgl_cfight_idx = #{cf_idx}) a
					cross join (select @rn := 0 , @mgl_club_idx :='')as var
					order by mgl_cfight_type_num ,`mgl_club_idx`)t
					order by mgl_cfight_type_num, rn,CASE `mgl_club_idx`
							when #{c_idx_1} then 1
							when #{c_idx_2} then 2
							when #{c_idx_3} then 3
							when #{c_idx_4} then 4
							end
	</select>
	<!-- 그룹테이블 인서트 -->
	<insert id="groupInsert">
		INSERT INTO
			MGL_CFIGHT_GROUP values
			<foreach collection="list" item="item" separator=",">
				(
				#{item.cf_g_idx},
				#{cf_idx},
				#{item.cf_t_idx},
				#{item.cf_g_no},
				#{item.cf_g_count}
				)
			</foreach>
	</insert>
	<!-- 팀테이블에 그룹인덱스 업데이트 -->
	<update id="teamGroupUpdate" >
		<foreach collection="list" item="item" separator=";">
			UPDATE MGL_CFIGHT_TEAM SET MGL_CFIGHT_GROUP_IDX = #{item.cf_g_idx} WHERE MGL_CFIGHT_TEAM_IDX = #{item.cf_team_idx}
		</foreach>
	</update>
	<!-- 그룹인덱스와 그룹 카운트를 구하는 SQL문 -->
	<select id="groupIdx" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_GROUP_IDX,MGL_CFIGHT_GROUP_COUNT 
		FROM 
			MGL_CFIGHT_GROUP A LEFT JOIN
			MGL_CFIGHT_TYPE B
		ON 
			A.MGL_cFIGHT_TYPE_IDX = B.MGL_CFIGHT_TYPE_IDX
		WHERE 
			A.MGL_CFIGHT_IDX = #{cf_idx}
		ORDER BY MGL_CFIGHT_TYPE_NUM		
	</select>
	<!-- 그룹인덱스를 조건으로 선수를 가져온다 -->
	<select id="groupAll" resultMap="CfightVOMap">
		SELECT 
			* 
		FROM 
			MGL_CFIGHT_TEAM 
		WHERE 
			MGL_CFIGHT_GROUP_IDX = #{cf_g_idx} 
		AND 
			MGL_CFIGHT_IDX = #{cf_idx}
	</select>
	<!-- 경기당 시간과 시작시간,코트수 -->
	<select id="gameDetail" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_STIME,MGL_CFIGHT_COURT,MGL_CFIGHT_TIME 
		FROM 
			MGL_CFIGHT 
		WHERE 
			MGL_CFIGHT_IDX = #{cf_idx}
		
	</select>
	<!-- 매치 테이블 인서트(대진표) -->
	<insert id="gameInsert">
		Insert into
			MGL_CFIGHT_WAIT VALUES
			<foreach collection="list" item="item" separator=",">
			(
			#{item.cf_gidx},
			#{cf_idx},
			#{item.cf_w_date},
			#{cf_status},
			#{item.cf_order},
			#{item.cf_no},
			#{item.cf_u_court},
			#{item.team_a_user_a},
			#{item.team_a_user_b},
			#{item.team_b_user_a},
			#{item.team_b_user_b},
			#{item.team_a_idx},
			#{item.team_b_idx}
			)
			</foreach>
	</insert>
	<!-- 대진표 생성됨을 알리는 업데이트 -->
	<update id="matchListYN">
		update mgl_CFIGHT set mgl_cfight_MATCH_LIST = "Y" WHERE MGL_CFIGHT_IDX = #{cf_idx}
	</update>
	<!-- 나의 대진표 -->
	<select id="myMatchList" resultMap="CfightVOMap">
		
		SELECT 
			A.MGL_CFIGHT_NM,B.* 
		FROM
			(
				SELECT 
					MGL_CFIGHT_NM,MGL_CFIGHT_IDX 
				FROM 
					MGL_CFIGHT WHERE MGL_CFIGHT_IDX = #{cf_idx}		
			) A
		RIGHT JOIN
		(
		SELECT 
			* 
		FROM
			(
				SELECT 
					A.*,B.*,F.*,C.*,Z.team_a_score,s.team_b_score 
				FROM 
					MGL_CFIGHT_WAIT A
				JOIN 
					( 
						select 
							mgl_cfight_type_idx as f_idx,mgl_cfight_type_idx,mgl_cfight_type_nm 
						from 
							MGL_CFIGHT_TYPE 
					) F 
				ON 
					substr(a.mgl_cfight_gidx,1,14) = f.f_idx 
				JOIN 
					( 
						SELECT 
							MGL_CLUB_NM as team_a_nm,MGL_CFIGHT_TEAM_IDX as team_a_idx 
						FROM 
							MGL_CFIGHT_TEAM q 
						JOIN 
							MGL_CLUB j 
						on 
							q.mgl_club_idx COLLATE utf8mb4_general_ci = j.mgl_club_idx 
					) B 
				ON 
					A.MGL_CFIGHT_A_TEAM_IDX = B.team_a_idx 
				JOIN 
					( 
						SELECT 
							MGL_CLUB_NM as team_b_nm,MGL_CFIGHT_TEAM_IDX as team_b_idx 
						FROM 
							MGL_CFIGHT_TEAM q 
						JOIN 
							MGL_CLUB j 
						on 
							q.mgl_club_idx COLLATE utf8mb4_general_ci = j.mgl_club_idx 
						WHERE 
							q.mgl_cfight_idx= #{cf_idx} 
					) C 
				ON 
					A.MGL_CFIGHT_B_TEAM_IDX = C.team_b_idx 
				LEFT JOIN 
					(
						SELECT 
							MGL_CFIGHT_TOTAL as team_a_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END
					) Z
				ON 
					A.MGL_CFIGHT_GIDX = Z.MGL_CFIGHT_GIDX
				AND 
					A.MGL_CFIGHT_A_TEAM_IDX = Z.MGL_CFIGHT_TEAM_IDX
				LEFT JOIN 
					(
						SELECT 
							MGL_CFIGHT_TOTAL as team_b_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END
					) S
				ON 
					A.MGL_CFIGHT_GIDX = S.MGL_CFIGHT_GIDX
				AND 
					A.MGL_CFIGHT_B_TEAM_IDX = S.MGL_CFIGHT_TEAM_IDX
				WHERE 
					MGL_CFIGHT_AT_ID1 = #{u_id} 
				OR 
					MGL_CFIGHT_AT_ID2 = #{u_id} 
				OR 
					MGL_CFIGHT_BT_ID1 = #{u_id} 
				OR 
					MGL_CFIGHT_BT_ID2 = #{u_id}
				and 
					a.MGL_CFIGHT_IDX = #{cf_idx} 
				GROUP BY 
					A.MGL_CFIGHT_GIDX 
			) JA
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID as a1,MGL_CFIGHT_USER_NM as a1_id,MGL_CFIGHT_USER_AGE as a1_age,MGL_CFIGHT_USER_GD as a1_gd 
					FROM 
						MGL_CFIGHT_USER
				) JB
			ON 
				JA.MGL_CFIGHT_AT_ID1 = JB.a1
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID as a2,MGL_CFIGHT_USER_NM as a2_id,MGL_CFIGHT_USER_AGE as a2_age,MGL_CFIGHT_USER_GD as a2_gd 
					FROM 
						MGL_CFIGHT_USER
				) JC
			ON 
				JA.MGL_CFIGHT_AT_ID2 = JC.a2
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID as b1,MGL_CFIGHT_USER_NM as b1_id,MGL_CFIGHT_USER_AGE as b1_age,MGL_CFIGHT_USER_GD as b1_gd 
					FROM 
						MGL_CFIGHT_USER
				) JD
			ON 
				JA.MGL_CFIGHT_BT_ID1 = JD.b1
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID as b2,MGL_CFIGHT_USER_NM as b2_id,MGL_CFIGHT_USER_AGE as b2_age,MGL_CFIGHT_USER_GD as b2_gd 
					FROM 
						MGL_CFIGHT_USER
				) JE
			ON 
				JA.MGL_CFIGHT_BT_ID2 = JE.b2
			GROUP BY 
				MGL_CFIGHT_GIDX
			ORDER BY 
				MGL_CFIGHT_W_DAT
		) B
		ON 
			A.MGL_CFIGHT_IDX = B.MGL_CFIGHT_IDX
	</select>
	<!-- 시간별로 대진표 -->
	<select id="timeMatchList" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_NM,MGL_CFIGHT_W_DAT FROM MGL_CFIGHT_WAIT A
		LEFT JOIN 
			MGL_CFIGHT B
		ON 
			A.MGL_CFIGHT_IDX = B.MGL_CFIGHT_IDX
		WHERE 
			A.MGL_CFIGHT_IDX = #{cf_idx}
		GROUP BY 
			MGL_CFIGHT_W_DAT
		ORDER BY 
			MGL_CFIGHT_W_DAT
	</select>
	<!-- 코트별로 대진표 -->
	<select id="courtMatchList" resultMap="CfightVOMap">
		SELECT 
			A.MGL_cFIGHT_COURT,MGL_CFIGHT_NM 
		FROM 
			MGL_CFIGHT_WAIT A
		LEFT 
			JOIN MGL_CFIGHT B
		ON 
			A.MGL_CFIGHT_IDX = B.MGL_CFIGHT_IDX
		WHERE 
			A.MGL_cFIGHT_IDX = #{cf_idx}
		GROUP BY 
			MGL_CFIGHT_COURT
		ORDER BY 
			MGL_CFIGHT_COURT
	</select>
	<!-- 코트나 시간으로대진표 출력 -->
	<select id="matchList" resultMap="CfightVOMap">
		SELECT 
			* 
		FROM
			(
				SELECT 
					A.*,B.*,F.*,C.*,Z.team_a_score,s.team_b_score 
				FROM 
					MGL_CFIGHT_WAIT A
				JOIN 
					( 
						select 
							mgl_cfight_type_idx as f_idx,mgl_cfight_type_idx,mgl_cfight_type_nm 
						from 
							MGL_CFIGHT_TYPE 
					) F 
				ON 
					substr(a.mgl_cfight_gidx,1,14) = f.f_idx 
				JOIN 
					( 
						SELECT 
							MGL_CLUB_NM as team_a_nm,MGL_CFIGHT_TEAM_IDX as team_a_idx 
						FROM 
							MGL_CFIGHT_TEAM q 
						JOIN 
							MGL_CLUB j 
						on 
							q.mgl_club_idx COLLATE utf8mb4_general_ci = j.mgl_club_idx 
					) B 
				ON 
					A.MGL_CFIGHT_A_TEAM_IDX = B.team_a_idx 
				JOIN 
					( 
						SELECT 
							MGL_CLUB_NM as team_b_nm,MGL_CFIGHT_TEAM_IDX as team_b_idx 
						FROM 
							MGL_CFIGHT_TEAM q 
						JOIN 
							MGL_CLUB j 
						on 
							q.mgl_club_idx COLLATE utf8mb4_general_ci = j.mgl_club_idx 
						WHERE 
							q.mgl_cfight_idx= #{cf_idx} 
					) C 
				ON 
					A.MGL_CFIGHT_B_TEAM_IDX = C.team_b_idx 
				LEFT JOIN 
					(
						SELECT 
							MGL_CFIGHT_TOTAL as team_a_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END
					) Z
				ON 
					A.MGL_CFIGHT_GIDX = Z.MGL_CFIGHT_GIDX
				AND 
					A.MGL_CFIGHT_A_TEAM_IDX = Z.MGL_CFIGHT_TEAM_IDX
				LEFT JOIN 
					(
						SELECT 
							MGL_CFIGHT_TOTAL as team_b_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END
					) S
				ON 
					A.MGL_CFIGHT_GIDX = S.MGL_CFIGHT_GIDX
				AND 
					A.MGL_CFIGHT_B_TEAM_IDX = S.MGL_CFIGHT_TEAM_IDX
				WHERE
					a.MGL_CFIGHT_IDX = #{cf_idx} 
				GROUP BY 
					A.MGL_CFIGHT_GIDX 
			) JA
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a1_id,MGL_CFIGHT_USER_AGE as a1_age,MGL_CFIGHT_USER_GD as a1_gd 
					FROM MGL_CFIGHT_USER
				) JB
			ON 
				JA.MGL_CFIGHT_AT_ID1 = JB.MGL_CFIGHT_USER_ID
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a2_id,MGL_CFIGHT_USER_AGE as a2_age,MGL_CFIGHT_USER_GD as a2_gd 
					FROM 
						MGL_CFIGHT_USER
				) JC
			ON 
				JA.MGL_CFIGHT_AT_ID2 = JC.MGL_CFIGHT_USER_ID
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b1_id,MGL_CFIGHT_USER_AGE as b1_age,MGL_CFIGHT_USER_GD as b1_gd 
					FROM 
						MGL_CFIGHT_USER
				) JD
			ON 
				JA.MGL_CFIGHT_BT_ID1 = JD.MGL_CFIGHT_USER_ID
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b2_id,MGL_CFIGHT_USER_AGE as b2_age,MGL_CFIGHT_USER_GD as b2_gd 
					FROM 
						MGL_CFIGHT_USER
				) JE
			ON 
				JA.MGL_CFIGHT_BT_ID2 = JE.MGL_CFIGHT_USER_ID
			GROUP BY 
				MGL_CFIGHT_GIDX
			ORDER BY 
				${type},MGL_CFIGHT_NO
	</select>
	<select id="typeMatchList" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_NM,MGL_CFIGHT_TYPE_NM,type_count,MGL_CFIGHT_GIDX
		FROM 
			MGL_CFIGHT_WAIT a 
		left join 
			mgl_cfight_type b
		ON 
			substr(a.mgl_cfight_gidx,1,14) = b.mgl_cfight_type_idx 
		left join 
			(
				select 
					count(*) as type_count,mgl_cfight_type_idx 
				from 
					mgl_cfight_team
				group by 
					mgl_cfight_type_idx
			) c
		on 
			b.mgl_cfight_type_idx = c.mgl_cfight_Type_idx
		left join 
			mgl_cfight d
		on 
			a.MGL_CFIGHT_IDX=d.mgl_cfight_idx
		WHERE 
			A.MGL_CFIGHT_IDX =#{cf_idx}
		AND 
			B.MGL_CFIGHT_IDX=#{cf_idx}
		GROUP BY 
			MGL_CFIGHT_TYPE_NM
		ORDER BY 
			MGL_CFIGHT_TYPE_NM
	</select>
	<!-- 종목 대진표 디테일 -->
	<select id="typeMatchDetail" resultMap="CfightVOMap">
		select 
			* 
		from
			(
				SELECT 
					A.*,B.*,D.*,E.*,Z.team_a_score,s.team_b_score
				FROM 
					(
						SELECT 
							* 
						FROM MGL_CFIGHT_WAIT
					) A
				LEFT JOIN 
					(
						SELECT 
							MGL_CLUB_NM as team_a_nm,MGL_CFIGHT_TEAM_IDX as a_idx 
						FROM 
							MGL_CFIGHT_TEAM T 
						JOIN 
							MGL_CLUB C
						ON 
							T.MGL_CLUB_IDX COLLATE utf8mb4_general_ci= C.MGL_CLUB_IDX
					) B
				ON 
					A.MGL_CFIGHT_A_TEAM_IDX = B.a_idx
				LEFT JOIN 
					(
						SELECT 
							MGL_CLUB_NM as team_b_nm,MGL_CFIGHT_TEAM_IDX as b_idx 
						FROM 
							MGL_CFIGHT_TEAM T 
						JOIN 
							MGL_CLUB C
						ON 
							T.MGL_CLUB_IDX COLLATE utf8mb4_general_ci= C.MGL_CLUB_IDX
					) D
				ON 
					A.MGL_CFIGHT_B_TEAM_IDX = D.b_idx
				LEFT JOIN 
					(
						SELECT 
							COUNT(*) AS group_count,MGL_CFIGHT_IDX as e_idx 
						FROM 
							MGL_CFIGHT_GROUP 
						WHERE 
							SUBSTR(MGL_CFIGHT_GROUP_IDX,1,14) = SUBSTR(#{cf_g_idx},1,14)
					) E
				ON 
					A.MGL_CFIGHT_IDX = E.e_idx
				LEFT JOIN 
					(
						SELECT 
							MGL_CFIGHT_TOTAL as team_a_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END
					) Z
				ON 
					A.MGL_CFIGHT_GIDX = Z.MGL_CFIGHT_GIDX
				AND 
					A.MGL_CFIGHT_A_TEAM_IDX = Z.MGL_CFIGHT_TEAM_IDX
				LEFT JOIN 
					(
						SELECT 
							MGL_CFIGHT_TOTAL as team_b_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END
					) S
				ON 
					A.MGL_CFIGHT_GIDX = S.MGL_CFIGHT_GIDX
				AND 
					A.MGL_CFIGHT_B_TEAM_IDX = S.MGL_CFIGHT_TEAM_IDX
				WHERE 
					SUBSTR(A.MGL_CFIGHT_GIDX,1,16) = #{cf_g_idx}
				GROUP BY 
					A.MGL_CFIGHT_GIDX
			) ja
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a1_id,MGL_CFIGHT_USER_AGE as a1_age,MGL_CFIGHT_USER_GD as a1_gd 
					FROM 
						MGL_CFIGHT_USER
				) JB
			ON 
				JA.MGL_CFIGHT_AT_ID1 = JB.MGL_CFIGHT_USER_ID
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a2_id,MGL_CFIGHT_USER_AGE as a2_age,MGL_CFIGHT_USER_GD as a2_gd 
					FROM 
						MGL_CFIGHT_USER
				) JC
			ON 
				JA.MGL_CFIGHT_AT_ID2 = JC.MGL_CFIGHT_USER_ID
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b1_id,MGL_CFIGHT_USER_AGE as b1_age,MGL_CFIGHT_USER_GD as b1_gd 
					FROM 
						MGL_CFIGHT_USER
				) JD
			ON 
				JA.MGL_CFIGHT_BT_ID1 = JD.MGL_CFIGHT_USER_ID
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b2_id,MGL_CFIGHT_USER_AGE as b2_age,MGL_CFIGHT_USER_GD as b2_gd 
					FROM 
						MGL_CFIGHT_USER
				) JE
			ON 
				JA.MGL_CFIGHT_BT_ID2 = JE.MGL_CFIGHT_USER_ID
			group by 
				mgl_cfight_gidx
			order by 
				mgl_cfight_gidx
	</select>
	<!-- 참가자 보기 (종목리스트) -->
	<select id="entryTypeList" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_NM,A.MGL_CFIGHT_TYPE_IDX,MGL_CFIGHT_TYPE_NM,group_count 
		FROM 
			MGL_CFIGHT_TYPE A
		LEFT JOIN 
			(
				select 
					count(*) AS GROUP_COUNT,MGL_CFIGHT_TYPE_IDX 
				from 
					mgl_cfight_team 
				where 
					mgl_cfight_idx =#{cf_idx} 
				group by 
					mgl_CFIGHT_TYPE_IDX
			) B
		ON 
			A.MGL_CFIGHT_tYPE_IDX = B.MGL_CFIGHT_TYPE_IDX
		LEFT JOIN 
			MGL_CFIGHT C 
		ON 
			A.MGL_CFIGHT_IDX = C.MGL_CFIGHT_IDX 
		WHERE 
			A.MGL_CFIGHT_IDX = #{cf_idx}
	</select>
	<!-- 참가자 보기 (종목 디테일) -->
	<select id="entryTypeDetail" resultMap="CfightVOMap">
		SELECT 
			mgl_club_nm,ja.mgl_cfight_group_idx,MGL_CFIGHT_USER_A,MGL_cFIGHT_USER_B,JB.MGL_CFIGHT_USER_NM AS a1_nm,jb.mgl_Cfight_user_age as a1_age,
			jb.mgl_cfight_user_gd as a1_gd ,Jc.MGL_CFIGHT_USER_NM AS b1_nm,jc.mgl_Cfight_user_age as b1_age,
			jc.mgl_cfight_user_gd as b1_gd 
		FROM
			(
				SELECT 
					MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_USER_A,MGL_CFIGHT_USER_B,MGL_CLUB_NM,MGL_CFIGHT_GROUP_IDX 
				FROM 
					MGL_CFIGHT_TEAM A 
				LEFT JOIN 
					MGL_CLUB B
				ON  
					a.mgl_CLUB_idx COLLATE utf8mb4_general_ci = b.mgl_CLUB_idx
				WHERE 
					a.MGL_CFIGHT_IDX = #{cf_idx}
			) JA 
		LEFT JOIN 
			MGL_CFIGHT_USER JB
		ON 
			JA.MGL_CFIGHT_USER_A = JB.MGL_CFIGHT_USER_ID
		LEFT JOIN 
			MGL_CFIGHT_USER JC
		ON 
			JA.MGL_CFIGHT_USER_B = JC.MGL_CFIGHT_USER_ID
		WHERE 
			JB.MGL_CFIGHT_IDX = #{cf_idx}
		AND 
			JC.MGL_CFIGHT_IDX = #{cf_idx}
		GROUP BY 
			MGL_CFIGHT_TEAM_IDX
	</select>
	<!-- 참가자 보기 (클럽리스트) -->
	<select id="entryClubList" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_NM,MGL_CLUB_NM,b.MGL_CLUB_IDX,group_count 
		FROM 
			MGL_CFIGHT_YN a 
		JOIN 
			MGL_CLUB b 
		USING(MGL_CLUB_IDX) 
		left join 
			(
				select 
					count(*) as group_count,mgl_club_idx 
				from
					mgl_cfight_team 
				where 
					mgl_cfight_idx = #{cf_idx} 
				group 
					by mgl_club_idx
			) c
		on 
			b.mgl_club_idx COLLATE utf8mb4_general_ci = c.mgl_club_idx
		LEFT JOIN 
			MGL_CFIGHT D 
		ON 
			A.MGL_CFIGHT_IDX = D.MGL_CFIGHT_IDX
		WHERE 
			A.MGL_CFIGHT_IDX = #{cf_idx}
	</select>
	<!-- 참가자 보기(클럽디테일) -->
	<select id="entryClubDetail" resultMap="CfightVOMap">
		SELECT 
			JA.MGL_CLUB_IDX,MGL_CFIGHT_USER_A,MGL_cFIGHT_USER_B,JB.MGL_CFIGHT_USER_NM AS a1_nm,jb.mgl_Cfight_user_age as a1_age,
			jb.mgl_cfight_user_gd as a1_gd ,Jc.MGL_CFIGHT_USER_NM AS b1_nm,jc.mgl_Cfight_user_age as b1_age,
			jc.mgl_cfight_user_gd as b1_gd,MGL_CFIGHT_TYPE_NM  
		FROM
			(
				SELECT 
					MGL_CFIGHT_USER_A,MGL_cFIGHT_USER_B,MGL_CFIGHT_TYPE_NM,MGL_CLUB_IDX 
				FROM 
					MGL_CFIGHT_TEAM A 
				LEFT JOIN 
					MGL_CFIGHT_TYPE B 
				ON 
					A.MGL_CFIGHT_TYPE_IDX = B.MGL_CFIGHT_TYPE_IDX
				WHERE 
					A.MGL_CFIGHT_IDX = #{cf_idx}
				AND 
					B.MGL_CFIGHT_IDX = #{cf_idx}
			)JA 
		LEFT JOIN 
			MGL_CFIGHT_USER JB
		ON 
			JA.MGL_CFIGHT_USER_A = JB.MGL_CFIGHT_USER_ID
		LEFT JOIN 
			MGL_CFIGHT_USER JC
		ON 
			JA.MGL_CFIGHT_USER_B = JC.MGL_CFIGHT_USER_ID
		WHERE 
			JB.MGL_CFIGHT_IDX = #{cf_idx}
		AND 
			JC.MGL_CFIGHT_IDX = #{cf_idx}
		AND 
			JB.MGL_CLUB_IDX = JC.MGL_CLUB_IDX 
	</select>
	<!-- 종목 디테일에 일정리스트 -->
	<select id="typeDetailList" resultMap="CfightVOMap">
		SELECT 
			* 
		FROM 
			( 
				SELECT 
					A.*,B.*,F.*,C.*,Z.team_a_score,s.team_b_score 
				FROM 
					MGL_CFIGHT_WAIT A
				JOIN 
					( 
						select 
							mgl_cfight_type_idx as f_idx,mgl_cfight_type_idx,mgl_cfight_type_nm 
						from 
							MGL_CFIGHT_TYPE 
					) F 
				ON 
					substr(a.mgl_cfight_gidx,1,14) = f.f_idx 
				JOIN 
					( 
						SELECT 
							MGL_CLUB_NM as team_a_nm,MGL_CFIGHT_TEAM_IDX as team_a_idx 
						FROM 
							MGL_CFIGHT_TEAM q 
						JOIN 
							MGL_CLUB j 
						on 
							q.mgl_club_idx COLLATE utf8mb4_general_ci = j.mgl_club_idx 
					) B 
				ON 
					A.MGL_CFIGHT_A_TEAM_IDX = B.team_a_idx 
				JOIN 
					( 
						SELECT 
							MGL_CLUB_NM as team_b_nm,MGL_CFIGHT_TEAM_IDX as team_b_idx 
						FROM 
							MGL_CFIGHT_TEAM q 
						JOIN 
							MGL_CLUB j 
						on 
							q.mgl_club_idx COLLATE utf8mb4_general_ci = j.mgl_club_idx 
						WHERE 
							q.mgl_cfight_idx= #{cf_idx} 
					) C 
				ON 
					A.MGL_CFIGHT_B_TEAM_IDX = C.team_b_idx 
				LEFT JOIN 
					(
						SELECT 
							MGL_CFIGHT_TOTAL as team_a_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END
					) Z
				ON 
					A.MGL_CFIGHT_GIDX = Z.MGL_CFIGHT_GIDX
				AND 
					A.MGL_CFIGHT_A_TEAM_IDX = Z.MGL_CFIGHT_TEAM_IDX
				LEFT JOIN 
					(
						SELECT 
							MGL_CFIGHT_TOTAL as team_b_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END
					) S
				ON 
					A.MGL_CFIGHT_GIDX = S.MGL_CFIGHT_GIDX
				AND 
					A.MGL_CFIGHT_B_TEAM_IDX = S.MGL_CFIGHT_TEAM_IDX
				WHERE
					a.MGL_CFIGHT_IDX = #{cf_idx} 
				GROUP BY 
					A.MGL_CFIGHT_GIDX 
			) JA 
				LEFT JOIN 
					( 
						SELECT 
							MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a1_id,MGL_CFIGHT_USER_AGE as a1_age,MGL_CFIGHT_USER_GD as a1_gd 
						FROM 
							MGL_CFIGHT_USER 
					) JB 
				ON 
					JA.MGL_CFIGHT_AT_ID1 = JB.MGL_CFIGHT_USER_ID 
				LEFT JOIN 
					( 
						SELECT 
							MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a2_id,MGL_CFIGHT_USER_AGE as a2_age,MGL_CFIGHT_USER_GD as a2_gd 
						FROM 
							MGL_CFIGHT_USER 
					) JC 
				ON 
					JA.MGL_CFIGHT_AT_ID2 = JC.MGL_CFIGHT_USER_ID 
				LEFT JOIN 
					( 
						SELECT 
							MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b1_id,MGL_CFIGHT_USER_AGE as b1_age,MGL_CFIGHT_USER_GD as b1_gd 
						FROM 
							MGL_CFIGHT_USER 
					) JD 
				ON 
					JA.MGL_CFIGHT_BT_ID1 = JD.MGL_CFIGHT_USER_ID 
				LEFT JOIN 
					( 
						SELECT 
							MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b2_id,MGL_CFIGHT_USER_AGE as b2_age,MGL_CFIGHT_USER_GD as b2_gd 
						FROM 
							MGL_CFIGHT_USER 
					) JE 
				ON 
					JA.MGL_CFIGHT_BT_ID2 = JE.MGL_CFIGHT_USER_ID
				WHERE 
					substr(mgl_cfight_gidx,1,16) = #{cf_g_idx}
				GROUP BY 
					MGL_CFIGHT_GIDX 
				ORDER BY 
					MGL_CFIGHT_W_DAT , MGL_CFIGHT_GIDX
	</select>
	<!-- 엔드 매치 인서트 -->
	<insert id="endGameInsert">
		Insert into
			MGL_CFIGHT_MATCH_END VALUES
			<foreach collection="list" item="item" separator=",">
			(
			#{item.cf_e_gidx},
			#{item.cf_gidx},
			#{cf_idx},
			#{item.c_idx},
			#{item.cf_t_idx},
			#{item.cf_g_idx},
			#{item.cf_team_idx},
			#{item.u_id},
			NULL,
			(
				SELECT 
					MGL_CFIGHT_USER_GD 
				FROM 
					MGL_CFIGHT_USER 
				WHERE 
					MGL_CFIGHT_USER_ID = #{item.u_id} 
				AND 
					MGL_CLUB_IDX = #{item.c_idx}
				AND
					MGL_CFIGHT_IDX = #{cf_idx}
			),
			(
				SELECT 
					MGL_CFIGHT_USER_AGE
				FROM 
					MGL_CFIGHT_USER 
				WHERE 
					MGL_CFIGHT_USER_ID = #{item.u_id} 
				AND 
					MGL_CLUB_IDX = #{item.c_idx}
				AND
					MGL_CFIGHT_IDX = #{cf_idx}
			),
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL,
			NULL
			)
			</foreach>
	</insert>
	<!-- 대진표 디테일 랭킹 -->
	<select id="typeDetailRank" resultMap="CfightVOMap">
		SELECT 
			* 
		FROM
		(
			SELECT 
				MGL_CLUB_IDX,MGL_cFIGHT_TEAM_IDX,MGL_CFIGHT_USER_A,MGL_CFIGHT_USER_B 
			FROM 
				MGL_cFIGHT_TEAM 
			WHERE 
				MGL_CFIGHT_GROUP_IDX = #{cf_g_idx}
		) JA
			LEFT JOIN
				(
					SELECT 
						MGL_CFIGHT_TEAM_IDX,SUM(MGL_CFIGHT_TOTAL)as total_sum,SUM(MGL_CFIGHT_CNT_GAP)as gap_sum,COUNT(CASE WHEN MGL_CFIGHT_WIN = "승" THEN 1 END) as win_count,COUNT(CASE WHEN MGL_CFIGHT_WIN = "패" THEN 1 END)as lose_count 
					FROM 
						MGL_CFIGHT_MATCH_END 
					WHERE 
						MGL_CFIGHT_GROUP_IDX = #{cf_g_idx}
					GROUP BY 
						MGL_CFIGHT_TEAM_IDX
				)JB
			ON 
				JA.MGL_CFIGHT_TEAM_IDX = JB.MGL_CFIGHT_TEAM_IDX
			LEFT JOIN 	
				( 
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a1_id 
					FROM 
						MGL_CFIGHT_USER 
					WHERE 
						MGL_CFIGHT_IDX = #{cf_idx}
				) JC 
			ON 
				JA.MGL_CFIGHT_USER_A = JC.MGL_CFIGHT_USER_ID
			LEFT JOIN 
				( 
					SELECT 
						MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b1_id 
					FROM 
						MGL_CFIGHT_USER 
					WHERE MGL_CFIGHT_IDX = #{cf_idx}
				) JD
			ON 
				JA.MGL_CFIGHT_USER_B = JD.MGL_CFIGHT_USER_ID
			LEFT JOIN 
				(
					SELECT 
						MGL_CLUB_IDX ,MGL_CLUB_NM 
					FROM 
						MGL_CLUB
				) JE
			ON 
				JA.MGL_CLUB_IDX COLLATE utf8mb4_general_ci= JE.MGL_CLUB_IDX
			group by 
				ja.mgl_cfight_Team_idx
			ORDER BY 
				WIN_COUNT DESC ,TOTAL_SUM DESC
	</select>
	<!-- 코트갯수 -->
	<select id="courtCount" resultType="int">
		SELECT 
			MGL_CFIGHT_COURT 
		FROM 
			MGL_CFIGHT WHERE MGL_CFIGHT_IDX = #{cf_idx}
	</select>
	<!-- 심판화면 -->
	<select id="referee" resultMap="CfightVOMap">
		SELECT 
			* 
		FROM 
			( 
				SELECT 
					A.*,B.*,F.*,C.*,Z.team_a_score,s.team_b_score 
				FROM 
					MGL_CFIGHT_WAIT A 
				JOIN 
					( 
						select 
							mgl_cfight_type_idx as f_idx,mgl_cfight_type_idx,mgl_cfight_type_nm 
						from 
							MGL_CFIGHT_TYPE 
					) F 
				ON 
					substr(a.mgl_cfight_gidx,1,14) = f.f_idx 
				JOIN 
					( 
						SELECT 
							MGL_CLUB_NM as team_a_nm,MGL_CFIGHT_TEAM_IDX as team_a_idx 
						FROM 
							MGL_CFIGHT_TEAM q 
						JOIN 
							MGL_CLUB j 
						on 
							q.mgl_club_idx COLLATE utf8mb4_general_ci = j.mgl_club_idx 
					) B 
				ON 
					A.MGL_CFIGHT_A_TEAM_IDX = B.team_a_idx 
				JOIN 
					( 
						SELECT 
							MGL_CLUB_NM as team_b_nm,MGL_CFIGHT_TEAM_IDX as team_b_idx 
						FROM 
							MGL_CFIGHT_TEAM q 
						JOIN 
							MGL_CLUB j 
						on 
							q.mgl_club_idx COLLATE utf8mb4_general_ci = j.mgl_club_idx 
						WHERE 
							q.mgl_cfight_idx= #{cf_idx} 
					) C 
				ON 
					A.MGL_CFIGHT_B_TEAM_IDX = C.team_b_idx 
				LEFT JOIN 
					( 
						SELECT 
							MGL_CFIGHT_TOTAL as team_a_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END 
					) Z 
				ON 
					A.MGL_CFIGHT_GIDX = Z.MGL_CFIGHT_GIDX 
				AND 
					A.MGL_CFIGHT_A_TEAM_IDX = Z.MGL_CFIGHT_TEAM_IDX 
				LEFT JOIN 
					( 
						SELECT 
							MGL_CFIGHT_TOTAL as team_b_score,MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_GIDX 
						FROM 
							MGL_CFIGHT_MATCH_END 
					) S 
				ON 
					A.MGL_CFIGHT_GIDX = S.MGL_CFIGHT_GIDX 
				AND 
					A.MGL_CFIGHT_B_TEAM_IDX = S.MGL_CFIGHT_TEAM_IDX 
				WHERE 
					a.MGL_CFIGHT_IDX =#{cf_idx} 
				GROUP BY 
					A.MGL_CFIGHT_GIDX 
			) JA 
		LEFT JOIN 
			( 
				SELECT 
					MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a1_id,MGL_CFIGHT_USER_AGE as a1_age,MGL_CFIGHT_USER_GD as a1_gd 
				FROM MGL_CFIGHT_USER 
			) JB 
		ON 
			JA.MGL_CFIGHT_AT_ID1 = JB.MGL_CFIGHT_USER_ID 
		LEFT JOIN 
			( 
				SELECT 
					MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a2_id,MGL_CFIGHT_USER_AGE as a2_age,MGL_CFIGHT_USER_GD as a2_gd 
				FROM 
					MGL_CFIGHT_USER 
			) JC 
		ON 
			JA.MGL_CFIGHT_AT_ID2 = JC.MGL_CFIGHT_USER_ID 
		LEFT JOIN 
			( 
				SELECT 
					MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b1_id,MGL_CFIGHT_USER_AGE as b1_age,MGL_CFIGHT_USER_GD as b1_gd 
				FROM 
					MGL_CFIGHT_USER 
			) JD 
		ON 
			JA.MGL_CFIGHT_BT_ID1 = JD.MGL_CFIGHT_USER_ID 
		LEFT JOIN 
			( 
				SELECT 
					MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b2_id,MGL_CFIGHT_USER_AGE as b2_age,MGL_CFIGHT_USER_GD as b2_gd 
				FROM 
					MGL_CFIGHT_USER 
			) JE 
		ON 
			JA.MGL_CFIGHT_BT_ID2 = JE.MGL_CFIGHT_USER_ID 
		WHERE 
			MGL_CFIGHT_COURT = #{cf_court}
		AND 
			MGL_CFIGHT_STATUS = "대기"
		GROUP BY 
			MGL_CFIGHT_GIDX 
		ORDER BY 
			MGL_CFIGHT_COURT,MGL_CFIGHT_NO 
	</select>
	<!-- 나의 순위 -->
	<select id="myRank" resultMap="CfightVOMap">
		SELECT 
			* 
		FROM 
			(
				SELECT 
					A.MGL_CFIGHT_TYPE_IDX,MGL_CFIGHT_TYPE_NM 
				FROM 
					MGL_CFIGHT_TEAM A 
				LEFT 
					JOIN MGL_CFIGHT_TYPE B 
				ON 
					A.MGL_CFIGHT_TYPE_IDX=B.MGL_CFIGHT_TYPE_IDX 
				WHERE 
					A.MGL_CFIGHT_IDX = #{cf_idx}
				AND 
					MGL_CFIGHT_USER_A = #{u_id} 
				OR 
					MGL_CFIGHT_USER_B = #{u_id}
			) JA
		LEFT JOIN
			(
				SELECT 
					MGL_CFIGHT_TYPE_IDX,MGL_CFIGHT_TEAM_IDX,SUM(MGL_CFIGHT_APTN) as sum_aptn,MGL_CLUB_NM 
				FROM 
					MGL_CFIGHT_MATCH_END A
				LEFT JOIN 
					MGL_CLUB B
				ON 
					A.MGL_CLUB_IDX COLLATE utf8mb4_general_ci= B.MGL_CLUB_IDX
				GROUP BY 
					MGL_CFIGHT_TEAM_IDX
			) JB
		ON 
			JA.MGL_CFIGHT_TYPE_IDX = JB.MGL_CFIGHT_TYPE_IDX
		LEFT JOIN
			( 
				SELECT 
					MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_USER_A,MGL_CFIGHT_USER_B 
				FROM 
					MGL_CFIGHT_TEAM 
				WHERE 
					MGL_CFIGHT_IDX = #{cf_idx}
			) JC
		ON 
			JC.MGL_CFIGHT_TEAM_IDX = JB.MGL_CFIGHT_TEAM_IDX
		LEFT JOIN 
			( SELECT MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as a1_id,MGL_CFIGHT_USER_AGE as a1_age,MGL_CFIGHT_USER_GD 
			as a1_gd FROM MGL_CFIGHT_USER WHERE MGL_CFIGHT_IDX=#{cf_idx}) JD ON JC.MGL_CFIGHT_USER_A = JD.MGL_CFIGHT_USER_ID
			LEFT JOIN 
			( SELECT MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b1_id,MGL_CFIGHT_USER_AGE as b1_age,MGL_CFIGHT_USER_GD 
			as b1_gd FROM MGL_CFIGHT_USER WHERE MGL_CFIGHT_IDX=#{cf_idx}) JE ON JC.MGL_CFIGHT_USER_B = JE.MGL_CFIGHT_USER_ID
		group by jc.mgl_cfight_team_idx ORDER BY JA.MGL_CFIGHT_TYPE_IDX ,sum_aptn desc
	</select>
	<!-- 내 종목 리스트 -->
	<select id="myTypeList" resultMap="CfightVOMap">
		SELECT MGL_CFIGHT_NM,A.MGL_CFIGHT_TYPE_IDX,MGL_CFIGHT_TYPE_NM FROM 
		(SELECT * FROM MGL_CFIGHT_TEAM WHERE MGL_CFIGHT_IDX= #{cf_idx})A LEFT 
JOIN MGL_CFIGHT_TYPE B ON A.MGL_CFIGHT_TYPE_IDX=B.MGL_CFIGHT_TYPE_IDX 
LEFT JOIN 
	MGL_CFIGHT C 
ON 
	A.MGL_CFIGHT_IDX = C.MGL_CFIGHT_IDX
WHERE 
	MGL_CFIGHT_USER_A = #{u_id} 
OR 
	MGL_CFIGHT_USER_B = #{u_id} 
AND
	A.MGL_CFIGHT_IDX = #{cf_idx} 
	</select>
	<!-- 대항전 종목 리스트 -->
	<select id="cfTypeList" resultMap="CfightVOMap">
	SELECT MGL_CFIGHT_NM,A.MGL_CFIGHT_TYPE_IDX,MGL_CFIGHT_TYPE_NM FROM MGL_CFIGHT_TEAM A LEFT 
JOIN MGL_CFIGHT_TYPE B ON A.MGL_CFIGHT_TYPE_IDX=B.MGL_CFIGHT_TYPE_IDX 
LEFT JOIN 
	MGL_CFIGHT C 
ON 
	A.MGL_CFIGHT_IDX = C.MGL_CFIGHT_IDX
WHERE A.MGL_CFIGHT_IDX 
= #{cf_idx} GROUP BY MGL_CFIGHT_TYPE_IDX order by MGL_CFIGHT_TYPE_IDX
	</select>
	<!-- 대항전 종목 순위 -->
	<select id="cfTypeRank" resultMap="CfightVOMap">
		SELECT * FROM ( SELECT A.MGL_CFIGHT_TYPE_IDX,MGL_CFIGHT_TYPE_NM FROM MGL_CFIGHT_TEAM A LEFT 
JOIN MGL_CFIGHT_TYPE B ON A.MGL_CFIGHT_TYPE_IDX=B.MGL_CFIGHT_TYPE_IDX WHERE A.MGL_CFIGHT_IDX 
= #{cf_idx}) JA LEFT 
JOIN ( SELECT MGL_CFIGHT_TYPE_IDX,MGL_CFIGHT_TEAM_IDX,SUM(MGL_CFIGHT_APTN) as sum_aptn,MGL_CLUB_NM 
FROM MGL_CFIGHT_MATCH_END A LEFT JOIN MGL_CLUB B ON A.MGL_CLUB_IDX COLLATE utf8mb4_general_ci= 
B.MGL_CLUB_IDX GROUP BY MGL_CFIGHT_TEAM_IDX ) JB ON JA.MGL_CFIGHT_TYPE_IDX = JB.MGL_CFIGHT_TYPE_IDX 
LEFT JOIN ( SELECT MGL_CFIGHT_TEAM_IDX,MGL_CFIGHT_USER_A,MGL_CFIGHT_USER_B FROM MGL_CFIGHT_TEAM 
WHERE MGL_CFIGHT_IDX = #{cf_idx} ) JC ON JC.MGL_CFIGHT_TEAM_IDX = JB.MGL_CFIGHT_TEAM_IDX 
LEFT JOIN ( SELECT MGL_CFIGHT_USER_ID ,MGL_CFIGHT_USER_NM as a1_id,MGL_CFIGHT_USER_AGE as a1_age,MGL_CFIGHT_USER_GD 
as a1_gd FROM MGL_CFIGHT_USER WHERE MGL_CFIGHT_IDX=#{cf_idx}) JD ON JC.MGL_CFIGHT_USER_A 
= JD.MGL_CFIGHT_USER_ID LEFT JOIN ( SELECT MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_NM as b1_id,MGL_CFIGHT_USER_AGE 
as b1_age,MGL_CFIGHT_USER_GD as b1_gd FROM MGL_CFIGHT_USER WHERE MGL_CFIGHT_IDX=#{cf_idx}) 
JE ON JC.MGL_CFIGHT_USER_B = JE.MGL_CFIGHT_USER_ID 
group by jb.mgl_cfight_team_idx
order by JA.MGL_CFIGHT_TYPE_IDX ,sum_aptn desc 
	</select>
	<!-- 손실공력 계산을 위한 유저정보 -->
	<select id="pointUser" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_USER_ID,MGL_CFIGHT_USER_SEX,MGL_CFIGHT_USER_GD,MGL_CFIGHT_USER_AGE 
		FROM
			MGL_CFIGHT_USER WHERE MGL_CFIGHT_IDX = #{cf_idx}
		AND 
			MGL_CFIGHT_USER_ID = #{a1_id}
		OR 
			MGL_CFIGHT_USER_ID = #{a2_id}
		OR 
			MGL_CFIGHT_USER_ID = #{b1_id}
		OR 
			MGL_CFIGHT_USER_ID = #{b2_id}
		GROUP BY 
			MGL_CFIGHT_USER_ID
		ORDER BY FIELD
			(MGL_CFIGHT_USER_ID,#{a1_id},#{a2_id},#{b1_id},#{b2_id})
		
	</select>
	<!-- 점수입력후 포인트계산 -->
	<update id="pointUpdate">
		<foreach collection="list" item="list" separator=";">
			UPDATE 
				MGL_CFIGHT_MATCH_END
			SET
				MGL_CFIGHT_UEFFORT = #{list.ueffort},
				MGL_CFIGHT_TOTAL = #{list.total},
				MGL_CFIGHT_CNT_GAP = #{list.cnt_gap},
				MGL_CFIGHT_WIN = #{list.win},
				MGL_CFIGHT_GPTN = #{list.gptn},
				MGL_CFIGHT_VPTN = #{list.vptn},
				MGL_CFIGHT_PPTN = #{list.pptn},
				MGL_CFIGHT_APTN = #{list.aptn},
				MGL_CFIGHT_END = sysdate()
			WHERE 
				MGL_CFIGHT_GIDX = #{cf_gidx}
			AND
				MGL_CFIGHT_USER_ID = #{list.cf_u_id}
		</foreach>
	</update>
	<!-- 게임 상태 변경 -->
	<update id="endUpdate">
		UPDATE 
			MGL_CFIGHT_WAIT
		SET
			MGL_CFIGHT_STATUS = "종료"
		WHERE 
			MGL_CFIGHT_GIDX = #{cf_gidx}
	</update>
	<!-- 클럽별 순위 -->
	<select id="clubRank" resultMap="CfightVOMap">
		SELECT 
			*,SUM(MGL_CFIGHT_APTN) AS sum_aptn 
		FROM 
			MGL_CFIGHT_MATCH_END A 
		LEFT 
			JOIN MGL_CLUB B
		ON 
			A.MGL_CLUB_IDX = B.MGL_CLUB_IDX
		LEFT JOIN 
			MGL_CFIGHT C 
		ON 
			A.MGL_CFIGHT_IDX = C.MGL_CFIGHT_IDX
		WHERE 
			A.MGL_CFIGHT_IDX = #{cf_idx}
		GROUP BY
			A.MGL_CLUB_IDX
		order by 
			sum_aptn desc
	</select>
	<!-- 푸쉬아이디 -->
	<select id="push" resultMap="CfightVOMap">
	SELECT MGL_USER_PUSHID AS token FROM MGL_USER WHERE MGL_USER_ID IN(#{a1_id},#{a2_id},#{b1_id},#{b2_id});
	</select>
	<!-- 올매치 -->
	<select id="all_court" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_COURT 
		FROM 
			MGL_CFIGHT_WAIT 
		WHERE 
			MGL_cFIGHT_IDX = #{cf_idx} 
		GROUP BY 
			MGL_CFIGHT_COURT 
		ORDER BY 
			MGL_CFIGHT_COURT
	</select>
	<select id="all_dat" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_W_DAT,MGL_CFIGHT_NM 
		FROM 
			MGL_CFIGHT_WAIT A
		LEFT JOIN 
			MGL_CFIGHT B 
		ON 
			A.MGL_CFIGHT_IDX = B.MGL_cFIGHT_IDX 
		WHERE 
			A.MGL_cFIGHT_IDX = #{cf_idx}
		GROUP BY 
			MGL_CFIGHT_W_DAT 
	</select>
	<select id="all_match" resultMap="CfightVOMap">
		SELECT 
			MGL_CFIGHT_GIDX,MGL_CFIGHT_W_DAT,MGL_CFIGHT_STATUS,MGL_CFIGHT_COURT 
		FROM 
			MGL_CFIGHT_WAIT 
		WHERE 
			MGL_CFIGHT_IDX = #{cf_idx} 
		ORDER BY 
			MGL_CFIGHT_W_DAT,MGL_CFIGHT_COURT
	</select>
	<!-- 대항전 이름 -->
	<select id="cf_nm" resultMap="CfightVOMap">
		SELECT MGL_CFIGHT_NM FROM MGL_cFIGHT WHERE MGL_cFIGHT_IDX=#{cf_idx}
	</select>
</mapper>