<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mgl.Board">

	<resultMap type="com.techni.mgl.domain.BoardVO" id="BoardVOMap">
		<result column="MGL_CLUB_NM"	 property="c_nm"/>
		<result column="MGL_USER_NM" property="u_nm"/>
		<result column="MGL_USER_PHOTO" property="u_photo"/>
		<result column="MGL_USER_ID" property="u_id"/>
		<result column="MGL_CLUB_BBS_IDX" property="cb_idx"/>
		<result column="MGL_CLUB_IDX" property="c_idx"/>
		<result column="MGL_CLUB_BBS_YN" property="cb_yn"/>
		<result column="MGL_CLUB_BBS_TITLE" property="cb_title"/>
		<result column="MGL_CLUB_BBS_CONTENT" property="cb_content"/>
		<result column="MGL_CLUB_BBS_HIT" property="cb_hit"/>
		<result column="MGL_USER_ID" property="u_id"/>
		<result column="MGL_CLUB_BBS_DATE" property="cb_date"/>
		<result column="MGL_CLUB_BBS_CH" property="cb_ch"/>
		<result column="MGL_CLUB_REPLY_IDX" property="cr_idx"/>
		<result column="MGL_CLUB_REPLY_CONTENT" property="cr_content"/>
		<result column="MGL_CLUB_REPLY_DATE" property="cr_date"/>
		<result column="MGL_CLUB_REPLY_CH" property="cr_ch"/>
		<result column="MGL_USER_PUSHID" property="u_push"/>
		<result column="MGL_HIT_IDX" property="h_idx"/>
	</resultMap>
	<!-- 푸시 넣어줄 데이터 -->
	<select id="pushList" resultMap="BoardVOMap">
		SELECT 
			MGL_CLUB_NM,MGL_USER_NM,MGL_USER_ID,MGL_USER_PUSHID FROM MGL_USER JOIN MGL_UCLUB USING(MGL_USER_ID) JOIN MGL_CLUB USING(MGL_CLUB_IDX)
		WHERE 
			MGL_CLUB_IDX = #{c_idx}
		AND 
			MGL_UCLUB_MNG != "가입대기"
		AND 
			MGL_UCLUB_MNG != "탈퇴"
		AND 
			MGL_USER_PUSHID IS NOT NULL 
		AND 
			MGL_USER_PUSHID != ""
	</select>
	<!-- 공지리스트 -->
	<select id="bbsList" resultMap="BoardVOMap">
		SELECT 
			* 
		FROM 
			( 
				SELECT 
					MGL_CLUB_IDX,MGL_CLUB_NM FROM MGL_CLUB 
				WHERE 
					MGL_CLUB_IDX = #{c_idx} 
			) JA 
			LEFT JOIN
			( 
				SELECT 
					h_cnt,h_chk,MGL_USER_NM,MGL_USER_PHOTO,A.MGL_CLUB_BBS_IDX,MGL_CLUB_IDX,MGL_CLUB_BBS_YN,MGL_CLUB_BBS_TITLE,A.MGL_USER_ID,MGL_CLUB_BBS_DATE,cr_cnt 
				FROM 
					MGL_USER C 
				JOIN 
					MGL_CLUB_BBS A 
				USING 
					(MGL_USER_ID) 
				left join
			(
				select 
					mgl_club_bbs_idx,count(mgl_user_id)as h_cnt ,count(case when mgl_user_id = #{u_id} then 1 end) as h_chk 
				from 
					mgl_hit 
				group by 
					mgl_club_bbs_idx
			) d 
			on 
				a.mgl_club_bbs_idx = d.mgl_club_bbs_idx
			LEFT JOIN 
			(
				select 
					mgl_club_bbs_idx,count(CASE WHEN MGL_CLUB_REPLY_CH = "N"THEN 1 END) as cr_cnt 
				from 
					mgl_club_reply 
				group by 
					mgl_club_bbs_idx
			) b
			on 
				a.mgl_club_bbs_idx = b.mgl_club_bbs_idx
			WHERE 
				MGL_CLUB_IDX = #{c_idx} 
			AND 
				MGL_CLUB_BBS_CH = "N" 
			GROUP BY 
				A.MGL_CLUB_BBS_IDX 
			) JB 
			ON 
				JA.MGL_CLUB_IDX = JB.MGL_CLUB_IDX 
			ORDER BY 
				MGL_CLUB_BBS_DATE DESC 
	</select>
	
	<!-- 공지 디테일 -->
	<select id="bbsDetail" resultMap="BoardVOMap">
		SELECT 
			h_cnt,B.MGL_CLUB_BBS_IDX , MGL_CLUB_IDX , MGL_CLUB_BBS_TITLE , MGL_CLUB_BBS_CONTENT, B.MGL_USER_ID , MGL_CLUB_BBS_DATE ,MGL_USER_NM,MGL_USER_PHOTO
		FROM 
			MGL_USER A
		JOIN 
			MGL_CLUB_BBS B
		USING
			(MGL_USER_ID)
		LEFT JOIN 
			(
				select 
					mgl_club_bbs_idx,count(mgl_user_id)as h_cnt 
				from 
					mgl_hit 
				group by 
					mgl_club_bbs_idx
			) d 
		on 
			b.mgl_club_bbs_idx = d.mgl_club_bbs_idx
		WHERE 
			B.MGL_CLUB_BBS_IDX = #{cb_idx}
	</select>
	
	<!-- 댓글 리스트 -->
	<select id="replyList" resultMap="BoardVOMap">
		SELECT 
			MGL_USER_ID,MGL_USER_NM,MGL_USER_PHOTO,MGL_CLUB_REPLY_CONTENT,MGL_CLUB_REPLY_DATE,MGL_CLUB_REPLY_IDX
		FROM 
			MGL_USER A
		JOIN 
			MGL_CLUB_REPLY B
		USING 
			(MGL_USER_ID)
		WHERE 
			MGL_CLUB_BBS_IDX = #{cb_idx}
		AND
			MGL_CLUB_REPLY_CH = "N"
	</select>
	
	<!-- 게시글 생성 -->
	<insert id="bbsInsert">
		INSERT INTO 
			MGL_CLUB_BBS VALUES (
				concat("CB",cast(date_format(now(),"%Y%m%d")as char(8)),LPAD((SELECT * FROM(SELECT MAX(MGL_CLUB_BBS_SEQ) FROM MGL_SEQ) NEXT),3,0)),
				#{c_idx},
				#{cb_yn},
				#{cb_title},
				#{cb_content},
				1,
				#{u_id},
				SYSDATE(),
				"N"
			)
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="bbsUpdate">
		UPDATE 
			MGL_CLUB_BBS 
		SET 
			MGL_CLUB_BBS_TITLE = #{cb_title} , 
			MGL_CLUB_BBS_CONTENT = #{cb_content}
		WHERE 
			MGL_CLUB_BBS_IDX = #{cb_idx}
	</update>
	
	<!-- 댓글 생성 -->
	<insert id="replyInsert">
		INSERT INTO
			MGL_CLUB_REPLY VALUES
			(
				concat("CR",cast(date_format(now(),"%Y%m%d")as char(8)),LPAD((SELECT * FROM(SELECT MAX(MGL_CLUB_REPLY_SEQ) FROM MGL_SEQ) NEXT),4,0)),
				#{cb_idx},
				#{u_id},
				#{cr_content},
				SYSDATE(),
				"N"
			)
	</insert>
	<!-- 게시글 시퀀스 업데이트 -->
	<update id="bbsSeq">
		update mgl_seq set mgl_club_bbs_seq = mgl_club_bbs_seq+1
	</update>
	<!-- 댓글 인서트 업데이트 -->
	<update id="replySeq">
		update mgl_seq set mgl_club_reply_seq = mgl_club_reply_seq+1
	</update>
	<!--  hit 시퀀스 증가 -->
	<update id="bbsHit">
		UPDATE 
			MGL_SEQ
		SET 
			MGL_HIT_SEQ = MGL_HIT_SEQ+1
	</update>
	<!-- 조회수 -->
	<insert id="hitInsert">
		INSERT INTO 
			MGL_HIT VALUES (
				concat("H",cast(date_format(now(),"%Y%m%d")as char(8)),LPAD((SELECT * FROM(SELECT MAX(MGL_HIT_SEQ) FROM MGL_SEQ) NEXT),4,0)),
				#{u_id},
				#{cb_idx}
			)
	</insert>
	<!-- 해당회원이 읽었는지 확인 -->
	<select id="hitUser" resultType="int">
		select 
			count(*) 
		from 
			mgl_hit 
		where 
			mgl_club_bbs_idx = #{cb_idx}
		and 
			mgl_user_id = #{u_id}
	</select>
	
	<!-- 게시글 삭제 -->
	<update id="bbsDel">
		update 
			mgl_club_bbs 
		set 
			mgl_club_bbs_ch = "Y"
		where mgl_club_bbs_idx = #{cb_idx}
	</update>
	<!-- 댓글 삭제 -->
	<update id="replyDel">
		update 
			mgl_club_reply 
		set 
			mgl_club_reply_ch = "Y"
		where mgl_club_reply_idx = #{cr_idx}
	</update>

	<select id="getBoardList" resultType="brdVO" parameterType="map">
		SELECT AL.*,CM.MGL_CLUB_NM as c_nm FROM (SELECT MGL_CLUB_NM FROM MGL_CLUB WHERE MGL_CLUB_IDX = #{CIDX}) AS CM LEFT JOIN (SELECT R.*,M.MGL_USER_NM AS m_nm,A.MGL_CLUB_NM,
				( 
					SELECT COUNT(*) FROM MGL_REPLY WHERE MGL_BBS_IDX = R.b_idx 
				) AS replyCnt
		FROM (
			SELECT
					MGL_BBS_IDX	 			AS b_idx
					,MGL_CLUB_IDX 			AS c_idx
					,MGL_BBS_CD				AS b_cd
					,MGL_BBS_NOTI_YN		AS b_noti_yn
					,MGL_BBS_VOTE_YN	AS b_vote_yn
					,MGL_BBS_TITLE			AS b_title
					,MGL_BBS_CONTENT	AS b_content
					,MGL_BBS_READCNT AS b_readCnt
					,MGL_USER_ID			AS m_id
					,MGL_BBS_DATE			AS b_regdate
					,MGL_BBS_SHOW		AS b_show
			FROM MGL_BBS
			WHERE
				MGL_CLUB_IDX = #{CIDX}
			AND
				MGL_BBS_NOTI_YN = #{NOTIYN}
			AND
				MGL_BBS_SHOW = 'Y'

			) R, MGL_CLUB A, MGL_USER M
			WHERE 
				R.c_idx = A.MGL_CLUB_IDX
			AND
				R.m_id = M.MGL_USER_ID
			ORDER BY
				R.b_regdate DESC,
				R.b_idx DESC
				) AL
				ON CM.MGL_CLUB_NM = AL.MGL_CLUB_NM
	</select>
	
	<insert id="setBoardWriteObj" parameterType="brdVO">
		INSERT INTO MGL_BBS (
			MGL_BBS_IDX,
			MGL_CLUB_IDX,
			MGL_BBS_CD,
			MGL_BBS_NOTI_YN,
			MGL_BBS_VOTE_YN,
			MGL_BBS_TITLE,
			MGL_BBS_CONTENT,
			MGL_USER_ID,
			MGL_BBS_DATE,
			MGL_BBS_SHOW
		) VALUES (
			( SELECT * FROM (SELECT COUNT(MGL_BBS_IDX) + 1 FROM MGL_BBS WHERE MGL_CLUB_IDX = #{c_idx} ) NEXT ),
			#{c_idx},
			#{b_cd},
			#{b_toti_yn},
			#{b_vote_yn},
			#{b_title},
			#{b_content},
			#{m_id},
			NOW(),
			'Y'
		)
	</insert>
	
	<select id="getBoardDetail" parameterType="String" resultType="brdVO">
		SELECT 
			R.*,
			(SELECT MGL_USER_NM FROM MGL_USER WHERE MGL_USER_ID = R.m_id ) as m_nm,
			(SELECT COUNT(*) FROM MGL_REPLY WHERE MGL_BBS_IDX = R.b_idx) as replyCnt
		FROM (
			SELECT
					MGL_BBS_IDX	 			AS b_idx
					,MGL_CLUB_IDX 			AS c_idx
					,MGL_BBS_CD				AS b_cd
					,MGL_BBS_NOTI_YN		AS b_noti_yn
					,MGL_BBS_VOTE_YN	AS b_vote_yn
					,MGL_BBS_TITLE			AS b_title
					,MGL_BBS_CONTENT	AS b_content
					,MGL_BBS_READCNT	AS b_readCnt
					,MGL_USER_ID			AS m_id
					,MGL_BBS_DATE			AS b_regdate
					,MGL_BBS_SHOW		AS b_show
			FROM MGL_BBS
			WHERE
				MGL_BBS_IDX = #{bIdx}
			AND
				MGL_BBS_SHOW = 'Y'
		) R
	</select>
</mapper>