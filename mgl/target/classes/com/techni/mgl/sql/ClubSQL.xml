<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mgl.Club">

	<resultMap type="com.techni.mgl.domain.ClubVO" id="ClubVOMap">
		<result column="MGL_CLUB_IDX" property="c_idx"/>
		<result column="MGL_CLUB_NM" property="c_nm"/>
		<result column="MGL_CLUB_BIRTH" property="c_birth"/>
		<result column="MGL_CLUB_TIME" property="c_time"/>
		<result column="MGL_CLUB_WEEK" property="c_week"/>
		<result column="MGL_CLUB_INFO" property="c_info"/>
		<result column="MGL_CLUB_ORG_YN" property="c_yn"/>
		<result column="MGL_CSTADIUM_NM" property="cst_nm"/>
		<result column="MGL_CLUB_COURT" property="c_court"/>
		<result column="MGL_CLUB_LOCATION" property="c_location"/>
		<result column="MGL_CLUB_PHOTO" property="c_photo"/>
		<result column="MGL_USER_MID" property="u_mid"/>
		<result column="MGL_CLUB_ORG_ID" property="c_org"/>
		<result column="MGL_USER_NM" property="u_nm"/>
		<result column="MGL_USER_TEL" property="u_tel"/>
		<result column="MGL_USER_PUSHID" property="u_push"/>
		<result column="MGL_UCLUB_MNG" property="u_mng"/>
		<result column="MGL_CLUB_COURT_SA"  property="c_court_sa"/>
		<result column="MGL_CLUB_COURT_SU"  property="c_court_su"/>
	</resultMap>
	<!-- 클럽생성 -->
	<insert id="insert">
		INSERT INTO 
				MGL_CLUB VALUES(
						concat("C",cast(date_format(now(),"%Y%m%d") as char(8)),LPAD((SELECT * FROM(SELECT max(MGL_CLUB_SEQ) FROM MGL_SEQ) NEXT),4,0)),
						#{c_nm},
						cast(date_format(now(),"%Y%m%d") as char(8)),
						#{c_info},
						"N",
						#{cst_nm},
						#{c_court_su},
						#{c_court_sa},
						#{c_location},
						"/resources/img/logo_img.png",
						#{u_mid},
						NULL,
						"Y"
				)
	</insert>
	
	<select id="selectOne" resultMap="ClubVOMap">
		SELECT * 
			FROM 
				(SELECT g.*,f.MGL_USER_PUSHID 
					FROM MGL_CLUB g join mgl_user f on g.mgl_user_mid = f.mgl_user_id
						WHERE MGL_CLUB_IDX = #{c_idx}
				) A , 
				(SELECT MGL_USER_NM,MGL_USER_TEL 
					FROM MGL_USER 
						WHERE MGL_USER_ID = (SELECT MGL_USER_MID 
									FROM MGL_CLUB 
										WHERE MGL_CLUB_IDX=#{c_idx})
				) B,
				(SELECT COUNT(MGL_USER_ID) as cu_cnt
					FROM MGL_UCLUB 
						WHERE MGL_CLUB_IDX=#{c_idx} 
						AND MGL_UCLUB_MNG != "가입대기" 
						AND MGL_UCLUB_MNG != "탈퇴"
				) C,
				(SELECT count(MGL_USER_ID),MGL_UCLUB_MNG 
					FROM MGL_UCLUB 
						WHERE MGL_USER_ID=#{u_id} 
						AND MGL_CLUB_IDX=#{c_idx}
				) D
			LEFT JOIN
				(SELECT MGL_USER_NM AS ga_nm,MGL_USER_TEL as ga_tel,MGL_UCLUB_MNG as ga,MGL_CLUB_IDX
					FROM MGL_USER INNER JOIN MGL_UCLUB USING(MGL_USER_ID)
						WHERE MGL_CLUB_IDX = #{c_idx}
						AND MGL_UCLUB_MNG = "총무") E
					ON E.MGL_CLUB_IDX = #{c_idx}
	</select>
	
	<!-- 클럽 디테일 들어가기전에 어디로갈지 정해주는 작업 -->
	<select id="detailChoice" resultType="int">
		SELECT COUNT(MGL_USER_ID) 
			FROM MGL_UCLUB E
				WHERE MGL_USER_ID = #{u_id} 
				AND MGL_CLUB_IDX = #{c_idx} 
				AND MGL_UCLUB_MNG != "가입대기" 
				AND MGL_UCLUB_MNG != "탈퇴"
		
	</select>
	<!-- 클럽수정 페이지 -->
	<select id="selectOneClub"  resultMap="ClubVOMap">
		SELECT 
			c_count,MGL_USER_NM,MGL_USER_TEL,MGL_USER_MID,MGL_CLUB_PHOTO,MGL_CLUB_NM , MGL_CLUB_INFO,MGL_CSTADIUM_NM,MGL_CLUB_LOCATION,MGL_CLUB_COURT_SU,MGL_CLUB_COURT_SA 
		FROM 
			MGL_CLUB 
		INNER JOIN MGL_USER
		ON MGL_USER_MID = MGL_USER_ID,
			(SELECT 
				COUNT(MGL_USER_ID) AS c_count 
			FROM 
				MGL_UCLUB 
			WHERE 
				MGL_CLUB_IDX =#{c_idx} 
			AND 
				MGL_UCLUB_MNG != '가입대기' 
			AND 
				MGL_UCLUB_MNG != '탈퇴') a
		WHERE 
			MGL_CLUB_IDX = #{c_idx}
	</select>
	<!-- 클럽삭제 -->
	<update id="clubDel">
		UPDATE
			MGL_CLUB
		SET
			MGL_CLUB_YN = "N"
		WHERE
			MGL_CLUB_IDX = #{c_idx}
	</update>
	
</mapper>